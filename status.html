<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kunlun Monitoring Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Inter font for Apple-like typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(8rem, 1fr));
            gap: 1rem;
        }

        .kv-k {
            font-size: 0.75rem;
            font-weight: 500;
            color: #86868b;
            letter-spacing: -0.01em;
        }

        .kv-v {
            font-size: 0.875rem;
            font-weight: 500;
            color: #1d1d1f;
            margin-top: 0.25rem;
        }

        .operate-button {
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            background: #0071e3;
            color: white;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .operate-button:hover {
            background: #0077ed;
            transform: translateY(-1px);
        }

        .offline {
            opacity: 0.8;
            border-left: 2px solid #ff3b30;
        }

        .online {
            border-left: 2px solid #30d158;
        }

        .server-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 1rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .server-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .bg-success {
            background-color: #30d158;
        }

        #trendChart {
            min-height: 300px;
            border-radius: 0.75rem;
            padding: 1rem;
            background: white;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 1.25rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            background: rgba(0, 0, 0, 0.05);
        }

        .status-badge::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-badge.online::before {
            background: #30d158;
        }

        .status-badge.offline::before {
            background: #ff3b30;
        }

        /* Fancy loading animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .loading {
            animation: pulse 2s infinite;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Settings button animation */
        .settings-btn {
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            transform: rotate(90deg);
        }

        /* Percentage circle animation */
        .percentage-circle circle {
            transition: stroke-dashoffset 0.5s ease;
        }
    </style>
</head>

<body class="min-h-screen p-6">
    <div id="root"></div>
    <div id="modal-root"></div>

    <!-- React and ReactDOM CDN -->
    <script src="https://cdn.jsdelivr.net/npm/react@17.0.2/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Axios CDN -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Feather Icons -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    
    <script>
        const { useState, useEffect, useMemo, useCallback, useReducer, useRef } = React;
        const HOST = '';


        // Helper functions
        const BtoGB = (bytes) => (bytes / 1024 / 1024 / 1024).toFixed(2);
        const usagePercentage = (used, total) => ((used / total) * 100).toFixed(2);
        const formatTime = (timestamp) => new Date(timestamp * 1000).toLocaleTimeString();
        const isOutdated = (timestamp) => Math.floor(Date.now() / 1000) - timestamp > 1 * 60;


        // 定义需要渲染的字段，实际服务器返回的字段中有一些不适合直接展示
        const TITLES = {
            hostname: ['主机名', '', '当前服务器的主机名称'],
            organization: ['组织', '','IP所有者/组织'],
            country: ['国家', '', '服務器所在國家'],
            region: ['地区', '', '服務器所在地區'],
            uptimeDays: ['运行时间', '天', '服务器自上次启动以来的运行天数'],

            tasksInfo: ['进程 (运行中/全部)', '', '当前运行的进程数量与总进程数量'],
            loadAverages: ['负载', '', '系统在过去 1、5、15 分钟的平均负载'],
            memoryUsage: ['内存', '', '当前内存使用情况，已用/可用'],

            trafficInfo: ['总流量 (接收/发送)', 'G', '服务器自上次启动以来的网络总流量，包括接收和发送的数据量'],
            connectionInfo: ['连接数 (TCP/UDP)', '', '当前 TCP 和 UDP 连接数'],
            netTxSpeedKB: ['上传速度', 'K', '当前网络上传速度'],
            netRxSpeedKB: ['下载速度', 'K', '当前网络下载速度'],

            updateAt: ['更新时间', '', '数据最后更新时间'],

            cpu_num_cores: ['CPU 核心数', '', 'CPU 的核心数量'],
            cpu_delay_us: ['CPU 延迟', 'μs', 'CPU 处理任务的延迟时间'],
            cpu_us_percent: ['CPU 用户占用', '%', '用户进程占用的 CPU 百分比'],
            cpu_sy_percent: ['CPU 系统占用', '%', '系统内核占用的 CPU 百分比'],
            cpu_ni_percent: ['CPU 低优先级', '%', '低优先级进程占用的 CPU 百分比'],
            cpu_id_percent: ['CPU 空闲', '%', 'CPU 空闲时间的百分比'],
            cpu_wa_percent: ['CPU IO等待', '%', 'CPU 等待 I/O 操作的时间百分比'],
            cpu_hi_percent: ['CPU 硬件中断', '%', '硬件中断占用的 CPU 百分比'],
            cpu_st_percent: ['CPU 被宿主机占用', '%', '虚拟机被宿主机占用的 CPU 百分比'],

            rootDiskInfo: ['根目录空间', '', '根目录磁盘的使用情况，已用/可用'],
            disk_delay_us: ['磁盘延迟', 'ms', '根目录磁盘 I/O 操作的延迟时间'],
            readsPerSecond: ['读取次数', '', '根目录磁盘采样周期内的读取操作次数'],
            writesPerSecond: ['写入次数', '', '根目录磁盘采样周期内的写入操作次数'],
            avgReadLatency: ['平均读取延迟', 'ms', '根目录磁盘读取操作的平均延迟时间'],
            avgWriteLatency: ['平均写入延迟', 'ms', '根目录磁盘写入操作的平均延迟时间'],
            diskUtilization: ['磁盘利用率', '%', '根目录磁盘的使用率百分比'],
            weightedIoTimePercent: ['加权I/O时间', '%', '根目录磁盘 I/O 操作的加权时间百分比'],
        };


        function PercentageCircle({ percentage }) {
            const radius = 20;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference * (1 - percentage);

            return React.createElement(
                'div',
                { className: 'inline-block align-middle mr-2', title: percentage * 100 + '%' },
                React.createElement(
                    'svg',
                    {
                        className: 'w-4 h-4 percentage-circle',
                        viewBox: '0 0 50 50',
                    },
                    React.createElement('circle', {
                        className: 'text-gray-100 stroke-current',
                        strokeWidth: '7',
                        fill: 'transparent',
                        r: radius,
                        cx: '25',
                        cy: '25',
                    }),
                    React.createElement('circle', {
                        className: 'text-blue-500 stroke-current',
                        strokeWidth: '7',
                        fill: 'transparent',
                        r: radius,
                        cx: '25',
                        cy: '25',
                        strokeDasharray: circumference,
                        strokeDashoffset: offset,
                        style: { transition: 'stroke-dashoffset 0.5s ease' },
                    })
                )
            );
        }


        function calculateAndNormalizeKeys(obj, keys) {
            // 对累计求和占比类字段进行求出分别百分比，例如 CPU 统计信息

            // 1. 计算 keys 列表中所有键的值的总和
            const total = keys.reduce((sum, key) => sum + (obj[key] || 0), 0);

            // 2. 遍历 keys 列表，将每个键的值除以总和，并保留两位小数
            keys.forEach(key => {
                if (obj[key] !== undefined) { // 确保键存在
                    obj[key] = parseFloat(((obj[key] / total) * 100).toFixed(2));
                }
            });

            // 3. 返回处理后的对象
            return obj;
        }


        function calculateUsedMemParcent(obj) {
            // 为统计行添加内存实际使用量和占比字段
            obj.mem_really_used_mib = (obj.mem_total_mib - (obj.mem_free_mib + obj.mem_buff_cache_mib)).toFixed(2);
            obj.mem_used_total_percent = (obj.mem_really_used_mib / obj.mem_total_mib * 100).toFixed(2);
            return obj;
        }

        const TrendModal = ({ clientId, onClose }) => {
            const [apiData, setApiData] = useState(null);
            const [chartData, setChartData] = useState(null);
            const [dataLevel, setDataLevel] = useState('seconds');
            const [selectedKeys, setSelectedKeys] = useState(null);
            const [availableKeys, setAvailableKeys] = useState([]);
            const [isLoading, setIsLoading] = useState(true);

            const dataLevelOptions = [
                { value: 'seconds', label: '最近一小时', title: '10秒递进' },
                { value: 'minutes', label: '最近一天', title: '60秒递进' },
                { value: 'hours', label: '最近一年', title: '60分钟递进' },
            ];

            const apiObjectKeys = {
                uptime_s: ["运行时间", "秒", "系统运行的总时间（秒）"],
                load_1min: ["负载-1分钟", "", "过去1分钟的系统平均负载"],
                load_5min: ["负载-5分钟负载", "", "过去5分钟的系统平均负载"],
                load_15min: ["负载-15分钟负载", "", "过去15分钟的系统平均负载"],

                running_tasks: ["任务数-正在进行", "", "当前正在运行的任务数量"],
                total_tasks: ["任务数-全部", "", "系统中总的任务数量"],

                cpu_num_cores: ["CPU-核心数", "", "CPU的核心数量"],
                cpu_delay_us: ["CPU-延迟", "μs", "CPU任务的延迟时间（微秒）"],
                cpu_user: ["CPU-用户占用", "%", "用户空间占用的CPU百分比"],
                cpu_system: ["CPU-系统占用", "%", "内核空间占用的CPU百分比"],
                cpu_nice: ["CPU-低优先级", "%", "低优先级进程占用的CPU百分比"],
                cpu_idle: ["CPU-空闲", "%", "CPU空闲时间的百分比"],
                cpu_iowait: ["CPU-IO等待", "%", "CPU等待IO操作的时间百分比"],
                cpu_irq: ["CPU-硬件中断", "%", "CPU处理硬中断的时间百分比"],
                cpu_softirq: ["CPU-软件中断", "%", "CPU处理软中断的时间百分比"],
                cpu_steal: ["CPU-被宿主机占用", "%", "虚拟CPU等待物理CPU的时间百分比"],

                mem_really_used_mib: ["内存-真实已用", "Mib", "减去缓存和缓冲的内存占用大小（MiB）"],
                mem_used_total_percent: ["内存-已用占比", "%", "真实内存使用量占比"],
                mem_total_mib: ["内存-全部", "MiB", "系统总内存大小（MiB）"],
                mem_free_mib: ["内存-空闲", "MiB", "系统空闲内存大小（MiB）"],
                mem_used_mib: ["内存-已用", "MiB", "系统已用内存大小（MiB）"],
                mem_buff_cache_mib: ["内存-缓存", "MiB", "用于缓存和缓冲的内存大小（MiB）"],

                tcp_connections: ["连接数-TCP", "个", "当前TCP连接数量"],
                udp_connections: ["连接数-UDP", "个", "当前UDP连接数量"],

                default_interface_net_rx_bytes: ["流量-下载速度", "Bit", "当前开机期间默认网络接口接收的总字节数"],
                default_interface_net_tx_bytes: ["流量-上传速度", "Bit", "当前开机期间默认网络接口发送的总字节数"],

                disk_delay_us: ["磁盘-延迟", "ms", "磁盘IO操作的延迟时间（毫秒）"],
                root_disk_total_kb: ["磁盘-根目录总空间", "KB", "根磁盘的总容量（KB）"],
                root_disk_avail_kb: ["磁盘-根目录可用空间", "KB", "根磁盘的可用容量（KB）"],
                reads_completed: ["磁盘-读取完成次数", "", "磁盘读取操作完成的次数"],
                writes_completed: ["磁盘-写入完成次数", "", "磁盘写入操作完成的次数"],
                reading_ms: ["磁盘-读取时间", "ms", "磁盘读取操作的总时间（毫秒）"],
                writing_ms: ["磁盘-写入时间", "ms", "磁盘写入操作的总时间（毫秒）"],
                iotime_ms: ["磁盘-IO时间", "ms", "磁盘IO操作的总时间（毫秒）"],
                ios_in_progress: ["磁盘-进行中的IO操作", "", "当前正在进行的磁盘IO操作数量"],
                weighted_io_time: ["磁盘-加权IO时间", "ms", "加权后的磁盘IO操作时间（毫秒）"],
            };

            const fetchHistoryData = useCallback(async () => {
                setIsLoading(true);
                try {
                    const endpoint = `/status/${dataLevel}`;
                    const response = await axios.get(`${HOST}${endpoint}`, {
                        params: { client_id: clientId },
                    });

                    const data = response.data.reverse();
                    data.map((item) => calculateAndNormalizeKeys(item, ["cpu_user", "cpu_system", "cpu_nice", "cpu_idle", "cpu_iowait", "cpu_irq", "cpu_softirq", "cpu_steal"]));
                    data.map((item) => calculateUsedMemParcent(item));

                    setApiData(data);

                    if (data && data.length > 0) {
                        const keys = Object.keys(data[0]).filter(
                            (key) => key !== 'client_id' && key !== 'timestamp' && apiObjectKeys.hasOwnProperty(key)
                        );
                        setAvailableKeys(keys);
                        if (!selectedKeys) {
                            setSelectedKeys(['load_1min']);
                        } else {
                            setSelectedKeys(JSON.parse(JSON.stringify(selectedKeys)));
                        }
                    }
                } catch (error) {
                    console.error('Error fetching history data:', error);
                } finally {
                    setIsLoading(false);
                }
            }, [clientId, dataLevel]);

            useEffect(() => {
                fetchHistoryData();
            }, [fetchHistoryData]);

            useEffect(() => {
                if (apiData && apiData.length > 0) {
                    function formatTimestamp(timestamp) {
                        const now = Date.now();
                        const targetTime = timestamp;
                        const diff = now - targetTime;

                        const seconds = (diff / 1000).toFixed(1);
                        const minutes = (seconds / 60).toFixed(1);
                        const hours = (minutes / 60).toFixed(1);
                        const days = (hours / 24).toFixed(1);

                        if (seconds < 3600) {
                            return `-${seconds}s`;
                        } else if (hours < 24) {
                            return `-${hours}h`;
                        } else {
                            return `-${days}d`;
                        }
                    }

                    const labels = apiData.map((item) => formatTimestamp(item.timestamp * 1000));

                    const CHART_COLORS = {
                        blue: '#007AFF',
                        green: '#34C759',
                        orange: '#FF9500',
                        red: '#FF3B30',
                        purple: '#AF52DE',
                        yellow: '#FFD60A',
                    };

                    const datasets = selectedKeys.map((key, index) => ({
                        label: apiObjectKeys[key][0],
                        data: apiData.map((item) => item[key]),
                        borderColor: Object.values(CHART_COLORS)[index % Object.keys(CHART_COLORS).length],
                        backgroundColor: Object.values(CHART_COLORS)[index % Object.keys(CHART_COLORS).length] + '20',
                        fill: true,
                        pointStyle: false,
                        borderWidth: 2,
                        tension: 0.4,
                    }));

                    setChartData({ labels, datasets });
                }
            }, [selectedKeys, apiData]);

            useEffect(() => {
                if (chartData) {
                    const ctx = document.getElementById('trendChart').getContext('2d');
                    Chart.defaults.font.family = "'Inter', -apple-system, BlinkMacSystemFont, sans-serif";

                    const chart = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index',
                            },
                            scales: {
                                x: {
                                    grid: {
                                        display: false,
                                    },
                                    ticks: {
                                        maxTicksLimit: 8,
                                        color: '#86868b',
                                        font: {
                                            size: 11,
                                        },
                                    },
                                },
                                y: {
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)',
                                    },
                                    ticks: {
                                        maxTicksLimit: 5,
                                        color: '#86868b',
                                        font: {
                                            size: 11,
                                        },
                                        callback: (value) => {
                                            const unit = apiObjectKeys[selectedKeys[0]][1];
                                            return value > 1000 ? 
                                                Number(value.toFixed(0)).toLocaleString() + unit :
                                                value.toFixed(1) + unit;
                                        },
                                    },
                                },
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        pointStyle: 'circle',
                                        padding: 20,
                                        color: '#1d1d1f',
                                        font: {
                                            size: 12,
                                            weight: '500',
                                        },
                                    },
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                    titleColor: '#1d1d1f',
                                    bodyColor: '#1d1d1f',
                                    borderColor: 'rgba(0, 0, 0, 0.1)',
                                    borderWidth: 1,
                                    padding: 12,
                                    bodyFont: {
                                        size: 12,
                                    },
                                    titleFont: {
                                        size: 12,
                                        weight: '600',
                                    },
                                    displayColors: false,
                                },
                            },
                        },
                    });

                    return () => chart.destroy();
                }
            }, [chartData, selectedKeys]);

            return React.createElement(
                'div',
                { className: 'fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center z-50 p-4' },
                React.createElement(
                    'div',
                    { className: 'modal-content w-full max-w-4xl' },
                    React.createElement(
                        'div',
                        { className: 'p-6' },
                        React.createElement(
                            'div',
                            { className: 'flex items-center justify-between mb-6' },
                            React.createElement('h2', { className: 'text-xl font-semibold tracking-tight' }, '统计数据'),
                            React.createElement(
                                'button',
                                {
                                    onClick: onClose,
                                    className: 'p-2 text-gray-500 hover:text-gray-700 rounded-full transition-colors',
                                },
                                React.createElement('i', { 'data-feather': 'x' })
                            )
                        ),
                        React.createElement(
                            'div',
                            { className: 'grid grid-cols-2 gap-4 mb-6' },
                            React.createElement(
                                'div',
                                { className: 'relative' },
                                React.createElement(
                                    'select',
                                    {
                                        value: dataLevel,
                                        onChange: (e) => setDataLevel(e.target.value),
                                        className: 'w-full p-3 pr-10 bg-white rounded-xl border border-gray-200 focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all appearance-none',
                                    },
                                    dataLevelOptions.map((option) =>
                                        React.createElement(
                                            'option',
                                            {
                                                key: option.value,
                                                value: option.value,
                                                title: option.title,
                                            },
                                            option.label
                                        )
                                    )
                                ),
                                React.createElement('i', {
                                    'data-feather': 'chevron-down',
                                    className: 'absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none',
                                })
                            ),
                            availableKeys.length > 0 &&
                            React.createElement(
                                'div',
                                { className: 'relative' },
                                React.createElement(
                                    'select',
                                    {
                                        value: selectedKeys,
                                        onChange: (e) => setSelectedKeys([e.target.value]),
                                        className: 'w-full p-3 pr-10 bg-white rounded-xl border border-gray-200 focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all appearance-none',
                                    },
                                    availableKeys.map((key) =>
                                        React.createElement(
                                            'option',
                                            {
                                                key: key,
                                                value: key,
                                                title: apiObjectKeys[key][2],
                                            },
                                            apiObjectKeys[key][0]
                                        )
                                    )
                                ),
                                React.createElement('i', {
                                    'data-feather': 'chevron-down',
                                    className: 'absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none',
                                })
                            )
                        ),
                        React.createElement(
                            'div',
                            {
                                className: 'relative bg-white rounded-2xl p-6 border border-gray-100',
                                style: { minHeight: '400px' },
                            },
                            isLoading ?
                                React.createElement(
                                    'div',
                                    { className: 'absolute inset-0 flex items-center justify-center' },
                                    React.createElement('div', { className: 'loading w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin' })
                                ) :
                                React.createElement('canvas', { id: 'trendChart' })
                        )
                    )
                )
            );
        };





        // Server component
        const Server = React.memo(({ server, isExpanded, onToggleExpand, selectedFields, onFieldSelection }) => {
            const modalRoot = document.getElementById('modal-root');
            if (!modalRoot) return null;

            const [showTrendModal, setShowTrendModal] = useState(false);

            const KeyValue = ({ k, v }) => {
                return React.createElement(
                    'div', 
                    { className: 'p-4 bg-white bg-opacity-50 rounded-xl backdrop-blur-sm border border-gray-100' },
                    React.createElement('span', { className: 'kv-k', title: TITLES[k][2] }, TITLES[k][0]),
                    React.createElement('div', { className: 'kv-v flex items-center' }, [v, TITLES[k][1]])
                );
            };

            return React.createElement(
                'div',
                { className: `server-card ${server.isOffline ? 'offline' : 'online'} mb-4` },
                React.createElement(
                    'div',
                    {
                        className: 'p-4 cursor-pointer hover:bg-gray-50 rounded-lg transition-colors',
                        onClick: onToggleExpand
                    },
                    React.createElement(
                        'div',
                        { className: 'grid-container' },
                        selectedFields.map((key) =>
                            React.createElement(KeyValue, { k: key, v: server[key] })
                        )
                    )
                ),
                isExpanded &&
                React.createElement(
                    'div',
                    { className: 'p-4 border-t border-gray-100' },
                    React.createElement(
                        'div',
                        { className: 'grid-container' },
                        Object.keys(TITLES)
                            .filter((key) => TITLES.hasOwnProperty(key) && !selectedFields.includes(key))
                            .map((key) =>
                                React.createElement(KeyValue, {
                                    k: key,
                                    v: server[key],
                                })
                            ),
                        React.createElement(
                            'div',
                            { className: 'flex justify-end mt-4' },
                            React.createElement(
                                'button',
                                {
                                    onClick: () => setShowTrendModal(true),
                                    className: 'operate-button flex items-center',
                                },
                                [
                                    React.createElement('i', { 
                                        className: 'mr-2',
                                        'data-feather': 'bar-chart-2'
                                    }),
                                    '统计'
                                ]
                            )
                        )
                    )
                ),
                showTrendModal && ReactDOM.createPortal(
                    React.createElement(TrendModal, {
                        clientId: server.client_id,
                        onClose: () => setShowTrendModal(false),
                    }),
                    modalRoot
                )
            );
        });

        // Reducer for managing expanded states
        const expandedStatesReducer = (state, action) => {
            switch (action.type) {
                case 'TOGGLE':
                    return { ...state, [action.machineId]: !state[action.machineId] };
                default:
                    return state;
            }
        };

        function App() {
            const [servers, setServers] = useState([]);
            const [expandedStates, dispatch] = useReducer(expandedStatesReducer, {});
            const [showFieldSelector, setShowFieldSelector] = useState(false);

            // 从 localStorage 中读取 selectedFields，如果不存在则使用默认值
            const [selectedFields, setSelectedFields] = useState(() => {
                const savedFields = localStorage.getItem('selectedFields');
                return savedFields ? JSON.parse(savedFields) : ['hostname', 'loadAverages', 'memoryUsage'];
            });

            const prevServersRef = useRef({}); // 存储上一次的服务器数据
            const renderServers = useRef({}); // 存储渲染用的服务器数据



            // 处理字段选择
            const handleFieldSelection = (key) => {
                let newSelectedFields;
                if (selectedFields.includes(key)) {
                    newSelectedFields = selectedFields.filter(field => field !== key);
                } else {
                    newSelectedFields = [...selectedFields, key];
                }
                setSelectedFields(newSelectedFields);

                // 将新的 selectedFields 存储到 localStorage
                localStorage.setItem('selectedFields', JSON.stringify(newSelectedFields));
            };


            // 计算 CPU 百分比
            const calculateCpuPercentages = (currentCpu, prevCpu) => {
                const diff = {
                    cpu_us: currentCpu.cpu_user - (prevCpu.cpu_user || 0),
                    cpu_sy: currentCpu.cpu_system - (prevCpu.cpu_system || 0),
                    cpu_ni: currentCpu.cpu_nice - (prevCpu.cpu_nice || 0),
                    cpu_id: currentCpu.cpu_idle - (prevCpu.cpu_idle || 0),
                    cpu_wa: currentCpu.cpu_iowait - (prevCpu.cpu_iowait || 0),
                    cpu_hi: currentCpu.cpu_irq - (prevCpu.cpu_irq || 0),
                    cpu_st: currentCpu.cpu_steal - (prevCpu.cpu_steal || 0),
                };

                const total = Object.values(diff).reduce((sum, value) => sum + value, 0);

                // 如果 total 为 0，则返回上一次的值
                if (total === 0) {
                    return {
                        cpu_us_percent: prevCpu.cpu_us_percent || '0.00',
                        cpu_sy_percent: prevCpu.cpu_sy_percent || '0.00',
                        cpu_ni_percent: prevCpu.cpu_ni_percent || '0.00',
                        cpu_id_percent: prevCpu.cpu_id_percent || '0.00',
                        cpu_wa_percent: prevCpu.cpu_wa_percent || '0.00',
                        cpu_hi_percent: prevCpu.cpu_hi_percent || '0.00',
                        cpu_st_percent: prevCpu.cpu_st_percent || '0.00',
                    };
                }

                return {
                    cpu_us_percent: ((diff.cpu_us / total) * 100).toFixed(2),
                    cpu_sy_percent: ((diff.cpu_sy / total) * 100).toFixed(2),
                    cpu_ni_percent: ((diff.cpu_ni / total) * 100).toFixed(2),
                    cpu_id_percent: ((diff.cpu_id / total) * 100).toFixed(2),
                    cpu_wa_percent: ((diff.cpu_wa / total) * 100).toFixed(2),
                    cpu_hi_percent: ((diff.cpu_hi / total) * 100).toFixed(2),
                    cpu_st_percent: ((diff.cpu_st / total) * 100).toFixed(2),
                };
            };

            // 计算网络流量速度（KB/s）
            const calculateNetworkSpeed = (currentNet, prevNet) => {
                const timeDiff = currentNet.timestamp - prevNet.timestamp;

                const diffRx = currentNet.default_interface_net_rx_bytes - (prevNet.default_interface_net_rx_bytes || currentNet.default_interface_net_rx_bytes);
                const diffTx = currentNet.default_interface_net_tx_bytes - (prevNet.default_interface_net_tx_bytes || currentNet.default_interface_net_tx_bytes);

                // 如果差值为 0，则返回上一次的值
                if (diffRx === 0 && diffTx === 0) {
                    return {
                        netRxSpeedKB: prevNet.netRxSpeedKB || 0.00,
                        netTxSpeedKB: prevNet.netTxSpeedKB || 0.00,
                    };
                }

                return {
                    netRxSpeedKB: (diffRx / 1024 / timeDiff).toFixed(2), // 转换为 KB/s
                    netTxSpeedKB: (diffTx / 1024 / timeDiff).toFixed(2), // 转换为 KB/s
                };
            };

            function processIOData(prevData, currentData) {
                // 计算时间差
                const timeDiff = currentData.timestamp - prevData.timestamp;

                // 计算I/O速率
                const readsPerSecond = ((currentData.reads_completed - prevData.reads_completed) / timeDiff).toFixed(2);
                const writesPerSecond = ((currentData.writes_completed - prevData.writes_completed) / timeDiff).toFixed(2);

                // 计算平均I/O延迟
                const avgReadLatency = (currentData.reading_ms / currentData.reads_completed).toFixed(2);
                const avgWriteLatency = (currentData.writing_ms / currentData.writes_completed).toFixed(2);

                // 计算磁盘利用率
                const diskUtilization = ((currentData.iotime_ms - prevData.iotime_ms) / (timeDiff * 1000000)).toFixed(2);

                // 计算加权I/O时间百分比
                const weightedIoTimePercent = ((currentData.weighted_io_time / currentData.iotime_ms)).toFixed(2);

                // 返回结果对象
                return {
                    readsPerSecond,
                    writesPerSecond,
                    avgReadLatency,
                    avgWriteLatency,
                    diskUtilization,
                    weightedIoTimePercent,
                };
            }

            // Fetch data without depending on expandedStates
            const fetchData = useCallback(async () => {
                try {
                    const response = await axios.get(`${HOST}/status/latest`);
                    const newServers = response.data;

                    // 遍历新数据，更新 renderServers
                    newServers.forEach(server => {

                        // 现在此次计算实际使用的内存
                        server.mem_really_used_mib = (server.mem_total_mib - (server.mem_free_mib + server.mem_buff_cache_mib)).toFixed(2);

                        // 准备缓存字段
                        const machineId = server.machine_id;
                        const prevServer = prevServersRef.current[machineId] || {};
                        const renderServer = renderServers.current[machineId] || {};

                        // 如果数据没有变化，则跳过
                        if (JSON.stringify(server) === JSON.stringify(prevServer)) {
                            return;
                        } else {
                            prevServersRef.current[machineId] = server;
                        }


                        // 计算 CPU 百分比和网络速度
                        const cpuPercentages = calculateCpuPercentages(server, prevServer);
                        const networkSpeed = calculateNetworkSpeed(server, prevServer);
                        const uptimeDays = `${Math.floor(server.uptime_s / 3600 / 24)}`


                        const PercentageInfo = ({ used, total, unit = 'G' }) => React.createElement('div', { className: 'flex justify-left items-center' },
                            PercentageCircle({ percentage: (used / total).toFixed(2) }),
                            React.createElement('span', null, `${(used / 1).toFixed(2)}/${(total / 1).toFixed(2)}${unit}`),
                        )


                        // 更新 renderServers
                        renderServers.current[machineId] = {
                            ...server,
                            ...cpuPercentages,
                            ...networkSpeed,
                            ...processIOData(prevServer, server),

                            loadAverages: `${server.load_1min}/${server.load_5min}/${server.load_15min}`,
                            updateAt: formatTime(server.timestamp),
                            memoryUsage: PercentageInfo({ used: (server.mem_really_used_mib / 1024).toFixed(2), total: (server.mem_total_mib / 1024).toFixed(2) }),
                            tasksInfo: `${server.running_tasks}/${server.total_tasks}`,
                            trafficInfo: `${BtoGB(server.default_interface_net_rx_bytes)}/${BtoGB(server.default_interface_net_tx_bytes)}`,
                            connectionInfo: `${server.tcp_connections}/${server.udp_connections}`,
                            rootDiskInfo: PercentageInfo({ used: BtoGB((server.root_disk_total_kb - server.root_disk_avail_kb) * 1024), total: BtoGB(server.root_disk_total_kb * 1024) }),
                            isOffline: isOutdated(server.timestamp),
                            uptimeDays: uptimeDays,
                        };

                    });

                    // console.log('renderServers',renderServers.current)
                    // 将 renderServers 转换为数组并更新状态
                    setServers(Object.values(renderServers.current));
                } catch (error) {
                    console.error('Error fetching data:', error);
                }
            }, []);

            // Fetch data on mount and set interval
            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 1000);
                return () => clearInterval(interval);
            }, [fetchData]);

            // Toggle expanded state without triggering network requests
            const toggleExpand = useCallback((machineId) => {
                dispatch({ type: 'TOGGLE', machineId });
            }, []);


            return React.createElement(
                'div',
                { className: 'max-w-7xl mx-auto' },
                React.createElement(
                    'div',
                    { className: 'flex items-center justify-between mb-8' },
                    React.createElement(
                        'h1',
                        { className: 'text-2xl font-semibold tracking-tight' },
                        'Kunlun Server Monitor'
                    ),
                    React.createElement(
                        'div',
                        { className: 'flex items-center space-x-4' },
                        React.createElement(
                            'div',
                            { className: `status-badge ${servers.filter(server => !isOutdated(server.timestamp)).length === servers.length ? 'online' : 'offline'}` },
                            `${servers.filter(server => !isOutdated(server.timestamp)).length}/${servers.length} Online`
                        ),
                        React.createElement(
                            'button',
                            {
                                className: 'settings-btn p-2 text-gray-500 hover:text-gray-700 rounded-full bg-white shadow-sm',
                                onClick: () => setShowFieldSelector(true),
                            },
                            React.createElement('i', { 'data-feather': 'settings' })
                        )
                    )
                ),
                React.createElement(
                    'div',
                    { className: 'space-y-4' },
                    servers.map(server =>
                        React.createElement(Server, {
                            key: server.machine_id,
                            server: server,
                            isExpanded: expandedStates[server.machine_id] || false,
                            onToggleExpand: () => toggleExpand(server.machine_id),
                            selectedFields: selectedFields,
                            onFieldSelection: handleFieldSelection
                        })
                    )
                ),
                showFieldSelector &&
                React.createElement(
                    'div',
                    { className: 'fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center z-50' },
                    React.createElement(
                        'div',
                        { className: 'modal-content p-6 max-w-2xl w-full mx-4' },
                        React.createElement(
                            'div',
                            { className: 'flex items-center justify-between mb-6' },
                            React.createElement('h3', { className: 'text-lg font-semibold' }, '选择优先显示字段'),
                            React.createElement(
                                'button',
                                {
                                    className: 'text-gray-500 hover:text-gray-700',
                                    onClick: () => setShowFieldSelector(false)
                                },
                                React.createElement('i', { 'data-feather': 'x' })
                            )
                        ),
                        React.createElement(
                            'div',
                            { className: 'grid grid-cols-3 gap-4' },
                            Object.keys(TITLES).map((key) =>
                                React.createElement(
                                    'label',
                                    { key, className: 'flex items-center p-3 bg-white rounded-lg cursor-pointer hover:bg-gray-50 transition-colors' },
                                    React.createElement('input', {
                                        type: 'checkbox',
                                        checked: selectedFields.includes(key),
                                        onChange: () => handleFieldSelection(key),
                                        className: 'mr-3 h-4 w-4 text-blue-500 rounded border-gray-300 focus:ring-blue-500'
                                    }),
                                    React.createElement('span', { className: 'text-sm font-medium' }, TITLES[key][0])
                                )
                            )
                        ),
                        React.createElement(
                            'div',
                            { className: 'flex justify-end mt-6' },
                            React.createElement(
                                'button',
                                {
                                    className: 'operate-button',
                                    onClick: () => setShowFieldSelector(false)
                                },
                                '确认'
                            )
                        )
                    )
                )
            );
        }

        ReactDOM.render(React.createElement(App), document.getElementById('root'));
        feather.replace();
    </script>
</body>

</html>
